

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Interception Extensions &mdash; Simple Injector 2 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="top" title="Simple Injector 2 documentation" href="index.html"/>
        <link rel="up" title="Appendix" href="appendix.html"/>
        <link rel="next" title="Collection Registration Extension" href="CollectionRegistrationExtensions.html"/>
        <link rel="prev" title="Runtime Decorators" href="RuntimeDecorators.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        <a href="index.html" class="fa fa-home"> Simple Injector</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
        
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#a-quick-example">A Quick Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="quickstart.html#more-information">More information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="using.html">Using Simple Injector</a><ul>
<li class="toctree-l2"><a class="reference internal" href="using.html#resolving-instances">Resolving instances</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#configuring-simple-injector">Configuring Simple Injector</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#verifying-the-container-s-configuration">Verifying the container&#8217;s configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#automatic-constructor-injection-auto-wiring">Automatic constructor injection / auto-wiring</a></li>
<li class="toctree-l2"><a class="reference internal" href="using.html#more-information">More information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="lifetimes.html">Object Lifetime Management</a><ul>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#transient">Transient</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#singleton">Singleton</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#scoped">Scoped</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-web-request">Per Web Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-web-api-request">Per Web API Request</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#web-api-request-lifestyle-vs-web-request-lifestyle">Web API Request lifestyle vs. Web Request lifestyle</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-wcf-operation">Per WCF Operation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-lifetime-scope">Per Lifetime Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-execution-context-scope">Per Execution Context Scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-graph">Per Graph</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-thread">Per Thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#per-http-session">Per HTTP Session</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#hybrid">Hybrid</a></li>
<li class="toctree-l2"><a class="reference internal" href="lifetimes.html#developing-a-custom-lifestyle">Developing a Custom Lifestyle</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">Integration Guide</a><ul>
<li class="toctree-l2"><a class="reference internal" href="mvcintegration.html">    ASP.NET MVC</a></li>
<li class="toctree-l2"><a class="reference internal" href="webapiintegration.html">    ASP.NET Web API</a></li>
<li class="toctree-l2"><a class="reference internal" href="webformsintegration.html">    ASP.NET Web Forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="windowsformsintegration.html">    Windows Forms</a></li>
<li class="toctree-l2"><a class="reference internal" href="wcfintegration.html">    WCF</a></li>
<li class="toctree-l2"><a class="reference internal" href="wpfintegration.html">    WPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="silverlightintegration.html">    Silverlight</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration.html#patterns">Patterns</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="diagnostics.html">Diagnostic Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#how-to-view-diagnostic-results">How to view diagnostic results</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#suppressing-warnings">Suppressing warnings</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="diagnostics.html#supported-warnings">Supported Warnings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="howto.html">How To</a><ul>
<li class="toctree-l2"><a class="reference internal" href="howto.html#register-factory-delegates">Register factory delegates</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#resolve-instances-by-key">Resolve instances by key</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#resolve-arrays-and-lists">Resolve arrays and lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#register-multiple-interfaces-with-the-same-implementation">Register multiple interfaces with the same implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#override-existing-registrations">Override existing registrations</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#verify-the-container-s-configuration">Verify the container&#8217;s configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html#work-with-dependency-injection-in-multi-threaded-applications">Work with dependency injection in multi-threaded applications</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced.html">Advanced Scenarios</a><ul>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#generics">Generics</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#batch-automatic-registration">Batch / Automatic registration</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#registration-of-open-generic-types">Registration of open generic types</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#mixing-collections-of-open-generic-and-non-generic-components">Mixing collections of open-generic and non-generic components</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#unregistered-type-resolution">Unregistered type resolution</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#context-based-injection">Context based injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#decorators">Decorators</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#interception">Interception</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#property-injection">Property injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#covariance-and-contravariance">Covariance and Contravariance</a></li>
<li class="toctree-l2"><a class="reference internal" href="advanced.html#registering-plugins-dynamically">Registering plugins dynamically</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="extensibility.html">Extensibility Points</a><ul>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-constructor-resolution-behavior">Overriding Constructor Resolution Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-property-injection-behavior">Overriding Property Injection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-parameter-injection-behavior">Overriding Parameter Injection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#resolving-unregistered-types">Resolving Unregistered Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#overriding-lifestyle-selection-behavior">Overriding Lifestyle Selection Behavior</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#intercepting-the-creation-of-types">Intercepting the Creation of Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="extensibility.html#building-up-external-instances">Building up External Instances</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pipeline.html">Simple Injector Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#registration-pipeline">Registration Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipeline.html#resolve-pipeline">Resolve Pipeline</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="principles.html">Design Principles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="principles.html#make-simple-use-cases-easy-make-complex-use-cases-possible">Make simple use cases easy, make complex use cases possible</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#push-developers-into-best-practices">Push developers into best practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#fast-by-default">Fast by default</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#don-t-force-vendor-lock-in">Don&#8217;t force vendor lock-in</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#never-fail-silently">Never fail silently</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#features-should-be-intuitive">Features should be intuitive</a></li>
<li class="toctree-l2"><a class="reference internal" href="principles.html#communicate-errors-clearly-and-describe-how-to-solve-them">Communicate errors clearly and describe how to solve them</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="decisions.html">Design Decisions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#the-container-is-locked-after-the-first-call-to-resolve">The container is locked after the first call to resolve</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#the-api-clearly-differentiates-the-registration-of-collections">The API clearly differentiates the registration of collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-support-for-xml-based-configuration">No support for XML based configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#never-force-users-to-release-what-they-resolve">Never force users to release what they resolve</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#don-t-allow-resolving-scoped-instances-outside-an-active-scope">Don&#8217;t allow resolving scoped instances outside an active scope</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-out-of-the-box-support-for-property-injection">No out-of-the-box support for property injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-out-of-the-box-support-for-interception">No out-of-the-box support for interception</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#limited-batch-registration-api">Limited batch-registration API</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#no-per-thread-lifestyle">No per-thread lifestyle</a></li>
<li class="toctree-l2"><a class="reference internal" href="decisions.html#allow-only-a-single-constructor">Allow only a single constructor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="legal.html">Legal stuff</a><ul>
<li class="toctree-l2"><a class="reference internal" href="legal.html#simple-injector-license">Simple Injector License</a></li>
<li class="toctree-l2"><a class="reference internal" href="legal.html#contributions">Contributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="legal.html#simple-injector-trademark-policy">Simple Injector Trademark Policy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contribute.html">How to Contribute</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="appendix.html">Appendix</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="RuntimeDecorators.html">Runtime Decorators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Interception Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="CollectionRegistrationExtensions.html">Collection Registration Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="ContextDependentExtensions.html">Context Dependent Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="varianceextensions.html">Variance Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="t4mvc.html">T4MVC</a></li>
<li class="toctree-l2"><a class="reference internal" href="injectproperties-is-deprecated.html">InjectProperties is Deprecated</a></li>
<li class="toctree-l2"><a class="reference internal" href="registermvcattributefilterprovider-is-deprecated.html">RegisterMvcAttributeFilterProvider is Deprecated</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://simpleinjector.org/ReferenceLibrary/">API Documentation</a></li>
</ul>

        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Simple Injector</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
          <li><a href="appendix.html">Appendix</a> &raquo;</li>
      
    <li>Interception Extensions</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="_sources/InterceptionExtensions.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            
  <div class="section" id="interception-extensions">
<h1>Interception Extensions<a class="headerlink" href="#interception-extensions" title="Permalink to this headline">Â¶</a></h1>
<p><strong>Adding interception abilities to the Simple Injector.</strong></p>
<div class="highlight-c#"><div class="highlight"><pre><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq.Expressions</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Reflection</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Remoting.Messaging</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Remoting.Proxies</span><span class="p">;</span>

<span class="k">using</span> <span class="nn">SimpleInjector</span><span class="p">;</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IInterceptor</span>
<span class="p">{</span>
    <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="n">IInvocation</span>
<span class="p">{</span>
    <span class="kt">object</span> <span class="n">InvocationTarget</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">object</span> <span class="n">ReturnValue</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">object</span><span class="p">[]</span> <span class="n">Arguments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">void</span> <span class="nf">Proceed</span><span class="p">();</span>
    <span class="n">MethodBase</span> <span class="nf">GetConcreteMethod</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Extension methods for interceptor registration</span>
<span class="c1">// NOTE: These extension methods can only intercept interfaces, not abstract types.</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">InterceptorExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">InterceptWith</span><span class="p">&lt;</span><span class="n">TInterceptor</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">Container</span> <span class="n">container</span><span class="p">,</span>
        <span class="n">Func</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TInterceptor</span> <span class="p">:</span> <span class="n">class</span><span class="p">,</span> <span class="n">IInterceptor</span> <span class="p">{</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s">&quot;container&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;predicate&quot;</span><span class="p">);</span>
        <span class="n">container</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">ConstructorResolutionBehavior</span><span class="p">.</span><span class="n">GetConstructor</span><span class="p">(</span>
            <span class="k">typeof</span><span class="p">(</span><span class="n">TInterceptor</span><span class="p">),</span> <span class="k">typeof</span><span class="p">(</span><span class="n">TInterceptor</span><span class="p">));</span>

        <span class="kt">var</span> <span class="n">interceptWith</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InterceptionHelper</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildInterceptorExpression</span> <span class="p">=</span>
                <span class="n">e</span> <span class="p">=&gt;</span> <span class="n">BuildInterceptorExpression</span><span class="p">&lt;</span><span class="n">TInterceptor</span><span class="p">&gt;(</span><span class="n">container</span><span class="p">),</span>
            <span class="n">Predicate</span> <span class="p">=</span> <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">predicate</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
        <span class="p">};</span>

        <span class="n">container</span><span class="p">.</span><span class="n">ExpressionBuilt</span> <span class="p">+=</span> <span class="n">interceptWith</span><span class="p">.</span><span class="n">OnExpressionBuilt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">InterceptWith</span><span class="p">(</span><span class="k">this</span> <span class="n">Container</span> <span class="n">container</span><span class="p">,</span>
        <span class="n">Func</span><span class="p">&lt;</span><span class="n">IInterceptor</span><span class="p">&gt;</span> <span class="n">interceptorCreator</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s">&quot;container&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">interceptorCreator</span><span class="p">,</span> <span class="s">&quot;interceptorCreator&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;predicate&quot;</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">interceptWith</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InterceptionHelper</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildInterceptorExpression</span> <span class="p">=</span>
                <span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">interceptorCreator</span><span class="p">)),</span>
            <span class="n">Predicate</span> <span class="p">=</span> <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">predicate</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
        <span class="p">};</span>

        <span class="n">container</span><span class="p">.</span><span class="n">ExpressionBuilt</span> <span class="p">+=</span> <span class="n">interceptWith</span><span class="p">.</span><span class="n">OnExpressionBuilt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">InterceptWith</span><span class="p">(</span><span class="k">this</span> <span class="n">Container</span> <span class="n">container</span><span class="p">,</span>
        <span class="n">Func</span><span class="p">&lt;</span><span class="n">ExpressionBuiltEventArgs</span><span class="p">,</span> <span class="n">IInterceptor</span><span class="p">&gt;</span> <span class="n">interceptorCreator</span><span class="p">,</span>
        <span class="n">Func</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s">&quot;container&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">interceptorCreator</span><span class="p">,</span> <span class="s">&quot;interceptorCreator&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;predicate&quot;</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">interceptWith</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InterceptionHelper</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildInterceptorExpression</span> <span class="p">=</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span>
                <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">interceptorCreator</span><span class="p">),</span>
                <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span>
            <span class="n">Predicate</span> <span class="p">=</span> <span class="n">type</span> <span class="p">=&gt;</span> <span class="n">predicate</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
        <span class="p">};</span>

        <span class="n">container</span><span class="p">.</span><span class="n">ExpressionBuilt</span> <span class="p">+=</span> <span class="n">interceptWith</span><span class="p">.</span><span class="n">OnExpressionBuilt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">InterceptWith</span><span class="p">(</span><span class="k">this</span> <span class="n">Container</span> <span class="n">container</span><span class="p">,</span>
        <span class="n">IInterceptor</span> <span class="n">interceptor</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">container</span><span class="p">,</span> <span class="s">&quot;container&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">interceptor</span><span class="p">,</span> <span class="s">&quot;interceptor&quot;</span><span class="p">);</span>
        <span class="n">RequiresIsNotNull</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="s">&quot;predicate&quot;</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">interceptWith</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InterceptionHelper</span><span class="p">(</span><span class="n">container</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">BuildInterceptorExpression</span> <span class="p">=</span> <span class="n">e</span> <span class="p">=&gt;</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">interceptor</span><span class="p">),</span>
            <span class="n">Predicate</span> <span class="p">=</span> <span class="n">predicate</span>
        <span class="p">};</span>

        <span class="n">container</span><span class="p">.</span><span class="n">ExpressionBuilt</span> <span class="p">+=</span> <span class="n">interceptWith</span><span class="p">.</span><span class="n">OnExpressionBuilt</span><span class="p">;</span>
    <span class="p">}</span>

<span class="na">    [DebuggerStepThrough]</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">Expression</span> <span class="n">BuildInterceptorExpression</span><span class="p">&lt;</span><span class="n">TInterceptor</span><span class="p">&gt;(</span>
        <span class="n">Container</span> <span class="n">container</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TInterceptor</span> <span class="p">:</span> <span class="k">class</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">interceptorRegistration</span> <span class="p">=</span> <span class="n">container</span><span class="p">.</span><span class="n">GetRegistration</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">TInterceptor</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">interceptorRegistration</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// This will throw an ActivationException</span>
            <span class="n">container</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">TInterceptor</span><span class="p">&gt;();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">interceptorRegistration</span><span class="p">.</span><span class="n">BuildExpression</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">RequiresIsNotNull</span><span class="p">(</span><span class="kt">object</span> <span class="n">instance</span><span class="p">,</span> <span class="kt">string</span> <span class="n">paramName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">instance</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentNullException</span><span class="p">(</span><span class="n">paramName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">InterceptionHelper</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">MethodInfo</span> <span class="n">NonGenericInterceptorCreateProxyMethod</span> <span class="p">=</span> <span class="p">(</span>
            <span class="k">from</span> <span class="n">method</span> <span class="k">in</span> <span class="nf">typeof</span><span class="p">(</span><span class="n">Interceptor</span><span class="p">).</span><span class="n">GetMethods</span><span class="p">()</span>
            <span class="k">where</span> <span class="n">method</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">&quot;CreateProxy&quot;</span>
            <span class="k">where</span> <span class="n">method</span><span class="p">.</span><span class="n">GetParameters</span><span class="p">().</span><span class="n">Length</span> <span class="p">==</span> <span class="m">3</span>
            <span class="k">select</span> <span class="n">method</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Single</span><span class="p">();</span>

        <span class="k">public</span> <span class="nf">InterceptionHelper</span><span class="p">(</span><span class="n">Container</span> <span class="n">container</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">Container</span> <span class="p">=</span> <span class="n">container</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">internal</span> <span class="n">Container</span> <span class="n">Container</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">private</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">internal</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">ExpressionBuiltEventArgs</span><span class="p">,</span> <span class="n">Expression</span><span class="p">&gt;</span> <span class="n">BuildInterceptorExpression</span>
        <span class="p">{</span>
            <span class="k">get</span><span class="p">;</span>
            <span class="k">set</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">internal</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Predicate</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

<span class="na">        [DebuggerStepThrough]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="nf">OnExpressionBuilt</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">ExpressionBuiltEventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Predicate</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ThrowIfServiceTypeNotAnInterface</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
                <span class="n">e</span><span class="p">.</span><span class="n">Expression</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">BuildProxyExpression</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="na">        [DebuggerStepThrough]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">ThrowIfServiceTypeNotAnInterface</span><span class="p">(</span><span class="n">ExpressionBuiltEventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// NOTE: We can only handle interfaces, because</span>
            <span class="c1">// System.Runtime.Remoting.Proxies.RealProxy only supports interfaces.</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">.</span><span class="n">IsInterface</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotSupportedException</span><span class="p">(</span><span class="s">&quot;Can&#39;t intercept type &quot;</span> <span class="p">+</span>
                    <span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">.</span><span class="n">Name</span> <span class="p">+</span> <span class="s">&quot; because it is not an interface.&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

<span class="na">        [DebuggerStepThrough]</span>
        <span class="k">private</span> <span class="n">Expression</span> <span class="nf">BuildProxyExpression</span><span class="p">(</span><span class="n">ExpressionBuiltEventArgs</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">interceptor</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">BuildInterceptorExpression</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

            <span class="c1">// Create call to</span>
            <span class="c1">// (ServiceType)Interceptor.CreateProxy(Type, IInterceptor, object)</span>
            <span class="kt">var</span> <span class="n">proxyExpression</span> <span class="p">=</span>
                <span class="n">Expression</span><span class="p">.</span><span class="n">Convert</span><span class="p">(</span>
                    <span class="n">Expression</span><span class="p">.</span><span class="n">Call</span><span class="p">(</span><span class="n">NonGenericInterceptorCreateProxyMethod</span><span class="p">,</span>
                        <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">,</span> <span class="k">typeof</span><span class="p">(</span><span class="n">Type</span><span class="p">)),</span>
                        <span class="n">interceptor</span><span class="p">,</span>
                        <span class="n">e</span><span class="p">.</span><span class="n">Expression</span><span class="p">),</span>
                    <span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">Expression</span> <span class="k">is</span> <span class="n">ConstantExpression</span> <span class="p">&amp;&amp;</span> <span class="n">interceptor</span> <span class="k">is</span> <span class="n">ConstantExpression</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">CreateInstance</span><span class="p">(</span><span class="n">proxyExpression</span><span class="p">),</span>
                    <span class="n">e</span><span class="p">.</span><span class="n">RegisteredServiceType</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">proxyExpression</span><span class="p">;</span>
        <span class="p">}</span>

<span class="na">        [DebuggerStepThrough]</span>
        <span class="k">private</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="n">Expression</span> <span class="n">expression</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">instanceCreator</span> <span class="p">=</span> <span class="n">Expression</span><span class="p">.</span><span class="n">Lambda</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;&gt;(</span><span class="n">expression</span><span class="p">,</span>
                <span class="k">new</span> <span class="n">ParameterExpression</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
                <span class="p">.</span><span class="n">Compile</span><span class="p">();</span>

            <span class="k">return</span> <span class="nf">instanceCreator</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Interceptor</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">CreateProxy</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">IInterceptor</span> <span class="n">interceptor</span><span class="p">,</span> <span class="n">T</span> <span class="n">realInstance</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">CreateProxy</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">T</span><span class="p">),</span> <span class="n">interceptor</span><span class="p">,</span> <span class="n">realInstance</span><span class="p">);</span>
    <span class="p">}</span>

<span class="na">    [DebuggerStepThrough]</span>
    <span class="k">public</span> <span class="k">static</span> <span class="kt">object</span> <span class="nf">CreateProxy</span><span class="p">(</span><span class="n">Type</span> <span class="n">serviceType</span><span class="p">,</span> <span class="n">IInterceptor</span> <span class="n">interceptor</span><span class="p">,</span>
        <span class="kt">object</span> <span class="n">realInstance</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">proxy</span> <span class="p">=</span> <span class="k">new</span> <span class="n">InterceptorProxy</span><span class="p">(</span><span class="n">serviceType</span><span class="p">,</span> <span class="n">realInstance</span><span class="p">,</span> <span class="n">interceptor</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">proxy</span><span class="p">.</span><span class="n">GetTransparentProxy</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">sealed</span> <span class="k">class</span> <span class="nc">InterceptorProxy</span> <span class="p">:</span> <span class="n">RealProxy</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">MethodBase</span> <span class="n">GetTypeMethod</span> <span class="p">=</span> <span class="k">typeof</span><span class="p">(</span><span class="kt">object</span><span class="p">).</span><span class="n">GetMethod</span><span class="p">(</span><span class="s">&quot;GetType&quot;</span><span class="p">);</span>

        <span class="k">private</span> <span class="kt">object</span> <span class="n">realInstance</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IInterceptor</span> <span class="n">interceptor</span><span class="p">;</span>

<span class="na">        [DebuggerStepThrough]</span>
        <span class="k">public</span> <span class="nf">InterceptorProxy</span><span class="p">(</span><span class="n">Type</span> <span class="n">classToProxy</span><span class="p">,</span> <span class="kt">object</span> <span class="n">realInstance</span><span class="p">,</span>
            <span class="n">IInterceptor</span> <span class="n">interceptor</span><span class="p">)</span>
            <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">classToProxy</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">realInstance</span> <span class="p">=</span> <span class="n">realInstance</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="n">interceptor</span> <span class="p">=</span> <span class="n">interceptor</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="n">IMessage</span> <span class="nf">Invoke</span><span class="p">(</span><span class="n">IMessage</span> <span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="k">is</span> <span class="n">IMethodCallMessage</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="p">(</span><span class="n">IMethodCallMessage</span><span class="p">)</span><span class="n">msg</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="kt">object</span><span class="p">.</span><span class="n">ReferenceEquals</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">MethodBase</span><span class="p">,</span> <span class="n">GetTypeMethod</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Bypass</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">InvokeMethodCall</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">IMessage</span> <span class="nf">InvokeMethodCall</span><span class="p">(</span><span class="n">IMethodCallMessage</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">var</span> <span class="n">invocation</span> <span class="p">=</span>
                <span class="k">new</span> <span class="n">Invocation</span> <span class="p">{</span> <span class="n">Proxy</span> <span class="p">=</span> <span class="k">this</span><span class="p">,</span> <span class="n">Message</span> <span class="p">=</span> <span class="n">message</span><span class="p">,</span> <span class="n">Arguments</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">Args</span> <span class="p">};</span>

            <span class="n">invocation</span><span class="p">.</span><span class="n">Proceeding</span> <span class="p">+=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="n">invocation</span><span class="p">.</span><span class="n">ReturnValue</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">MethodBase</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span>
                    <span class="k">this</span><span class="p">.</span><span class="n">realInstance</span><span class="p">,</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">);</span>
            <span class="p">};</span>

            <span class="k">this</span><span class="p">.</span><span class="n">interceptor</span><span class="p">.</span><span class="n">Intercept</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">ReturnMessage</span><span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">ReturnValue</span><span class="p">,</span> <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">,</span>
                <span class="n">invocation</span><span class="p">.</span><span class="n">Arguments</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">IMessage</span> <span class="nf">Bypass</span><span class="p">(</span><span class="n">IMethodCallMessage</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">object</span> <span class="k">value</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">MethodBase</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">realInstance</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Args</span><span class="p">);</span>

            <span class="k">return</span> <span class="k">new</span> <span class="nf">ReturnMessage</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Args</span><span class="p">,</span> <span class="n">message</span><span class="p">.</span><span class="n">Args</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">class</span> <span class="nc">Invocation</span> <span class="p">:</span> <span class="n">IInvocation</span>
        <span class="p">{</span>
            <span class="k">public</span> <span class="k">event</span> <span class="n">Action</span> <span class="n">Proceeding</span><span class="p">;</span>
            <span class="k">public</span> <span class="n">InterceptorProxy</span> <span class="n">Proxy</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">Arguments</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="n">IMethodCallMessage</span> <span class="n">Message</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
            <span class="k">public</span> <span class="kt">object</span> <span class="n">ReturnValue</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

            <span class="k">public</span> <span class="kt">object</span> <span class="n">InvocationTarget</span> <span class="p">{</span>
                <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Proxy</span><span class="p">.</span><span class="n">realInstance</span><span class="p">;</span> <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="k">void</span> <span class="nf">Proceed</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="n">Proceeding</span><span class="p">();</span>
            <span class="p">}</span>

            <span class="k">public</span> <span class="n">MethodBase</span> <span class="nf">GetConcreteMethod</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Message</span><span class="p">.</span><span class="n">MethodBase</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>After copying the previous code snippet to your project, you can add interception using the following lines of code:</p>
<div class="highlight-c#"><div class="highlight"><pre><span class="c1">// Register a MonitoringInterceptor to intercept all interface</span>
<span class="c1">// service types, which type name end with the text &#39;Service&#39;.</span>
<span class="n">container</span><span class="p">.</span><span class="n">InterceptWith</span><span class="p">&lt;</span><span class="n">MonitoringInterceptor</span><span class="p">&gt;(</span>
    <span class="n">serviceType</span> <span class="p">=&gt;</span> <span class="n">serviceType</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="n">EndsWith</span><span class="p">(</span><span class="s">&quot;Service&quot;</span><span class="p">));</span>

<span class="c1">// When the interceptor (and its dependencies) are thread-safe,</span>
<span class="c1">// it can be registered as singleton to prevent a new instance</span>
<span class="c1">// from being created and each call. When the intercepted service</span>
<span class="c1">// and both the interceptor are both singletons, the returned</span>
<span class="c1">// (proxy) instance will be a singleton as well.</span>
<span class="n">container</span><span class="p">.</span><span class="n">RegisterSingle</span><span class="p">&lt;</span><span class="n">MonitoringInterceptor</span><span class="p">&gt;();</span>

<span class="c1">// Here is an example of an interceptor implementation.</span>
<span class="c1">// NOTE: Interceptors must implement the IInterceptor interface:</span>
<span class="k">private</span> <span class="k">class</span> <span class="nc">MonitoringInterceptor</span> <span class="p">:</span> <span class="n">IInterceptor</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ILogger</span> <span class="n">logger</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">MonitoringInterceptor</span><span class="p">(</span><span class="n">ILogger</span> <span class="n">logger</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">logger</span> <span class="p">=</span> <span class="n">logger</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Intercept</span><span class="p">(</span><span class="n">IInvocation</span> <span class="n">invocation</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">var</span> <span class="n">watch</span> <span class="p">=</span> <span class="n">Stopwatch</span><span class="p">.</span><span class="n">StartNew</span><span class="p">();</span>

        <span class="c1">// Calls the decorated instance.</span>
        <span class="n">invocation</span><span class="p">.</span><span class="n">Proceed</span><span class="p">();</span>

        <span class="kt">var</span> <span class="n">decoratedType</span> <span class="p">=</span> <span class="n">invocation</span><span class="p">.</span><span class="n">InvocationTarget</span><span class="p">.</span><span class="n">GetType</span><span class="p">();</span>

        <span class="k">this</span><span class="p">.</span><span class="n">logger</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0} executed in {1} ms.&quot;</span><span class="p">,</span>
            <span class="n">decoratedType</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">watch</span><span class="p">.</span><span class="n">ElapsedMiliseconds</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="CollectionRegistrationExtensions.html" class="btn btn-neutral float-right" title="Collection Registration Extension"/>Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="RuntimeDecorators.html" class="btn btn-neutral" title="Runtime Decorators"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2014, Simple Injector Contributors.
    </p>
  </div>

  <a href="https://github.com/snide/sphinx_rtd_theme">Sphinx theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>